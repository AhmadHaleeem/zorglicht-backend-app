<%- include('../partials/header') %>

<div class="container-fluid">
    <div class="row">
        <%- include('../partials/sidebar') %>
        
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">
                    <i class="bi bi-folder me-2"></i>
                    <%= title %>
                </h1>
                <div class="btn-toolbar mb-2 mb-md-0">
                    <% if (canUpload) { %>
                        <a href="/bestanden/uploaden" class="btn btn-primary">
                            <i class="bi bi-cloud-upload me-2"></i>
                            Bestanden Uploaden
                        </a>
                    <% } %>
                </div>
            </div>
            
            <!-- Flash Messages -->
            <% if (typeof messages !== 'undefined' && messages.error && messages.error.length > 0) { %>
                <% messages.error.forEach(function(msg) { %>
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <%- msg %>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                <% }); %>
            <% } %>
            
            <% if (typeof messages !== 'undefined' && messages.success && messages.success.length > 0) { %>
                <% messages.success.forEach(function(msg) { %>
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        <i class="bi bi-check-circle me-2"></i>
                        <%- msg %>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                <% }); %>
            <% } %>
            
            <!-- Files Statistics -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="card-title"><%= files.length %></h4>
                                    <p class="card-text">Totaal Bestanden</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="bi bi-files fs-1"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="card-title"><%= files.reduce((total, file) => total + file.grootte, 0) / (1024 * 1024) %> MB</h4>
                                    <p class="card-text">Totale Grootte</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="bi bi-hdd fs-1"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="card-title"><%= [...new Set(files.map(f => f.type))].length %></h4>
                                    <p class="card-text">Bestandstypen</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="bi bi-file-earmark fs-1"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="card-title"><%= [...new Set(files.map(f => f.eigenaar))].length %></h4>
                                    <p class="card-text">Eigenaren</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="bi bi-people fs-1"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Search and Filter -->
            <div class="row mb-3">
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control" id="searchFiles" placeholder="Zoek bestanden...">
                    </div>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="filterType">
                        <option value="">Alle typen</option>
                        <option value="application/pdf">PDF</option>
                        <option value="image">Afbeeldingen</option>
                        <option value="application/vnd.ms-excel">Excel</option>
                        <option value="application/msword">Word</option>
                        <option value="text">Tekst</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="sortBy">
                        <option value="naam">Sorteer op naam</option>
                        <option value="uploaddatum">Sorteer op datum</option>
                        <option value="grootte">Sorteer op grootte</option>
                        <option value="type">Sorteer op type</option>
                    </select>
                </div>
            </div>
            
            <!-- Files List -->
            <% if (files.length === 0) { %>
                <div class="text-center py-5">
                    <i class="bi bi-folder-x display-1 text-muted"></i>
                    <h3 class="mt-3 text-muted">Geen bestanden gevonden</h3>
                    <p class="text-muted">Er zijn nog geen bestanden ge√ºpload.</p>
                    <% if (canUpload) { %>
                        <a href="/bestanden/uploaden" class="btn btn-primary">
                            <i class="bi bi-cloud-upload me-2"></i>
                            Upload je eerste bestand
                        </a>
                    <% } %>
                </div>
            <% } else { %>
                <div class="row" id="filesContainer">
                    <% files.forEach(file => { %>
                        <div class="col-md-6 col-lg-4 mb-3 file-item" 
                             data-name="<%= file.naam.toLowerCase() %>" 
                             data-type="<%= file.type %>" 
                             data-date="<%= file.uploaddatum %>" 
                             data-size="<%= file.grootte %>">
                            <div class="card h-100 file-card">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div class="file-icon">
                                            <% if (file.type.startsWith('image/')) { %>
                                                <i class="bi bi-file-earmark-image text-success fs-2"></i>
                                            <% } else if (file.type === 'application/pdf') { %>
                                                <i class="bi bi-file-earmark-pdf text-danger fs-2"></i>
                                            <% } else if (file.type.includes('excel') || file.type.includes('spreadsheet')) { %>
                                                <i class="bi bi-file-earmark-excel text-success fs-2"></i>
                                            <% } else if (file.type.includes('word') || file.type.includes('document')) { %>
                                                <i class="bi bi-file-earmark-word text-primary fs-2"></i>
                                            <% } else if (file.type.startsWith('text/')) { %>
                                                <i class="bi bi-file-earmark-text text-info fs-2"></i>
                                            <% } else { %>
                                                <i class="bi bi-file-earmark text-secondary fs-2"></i>
                                            <% } %>
                                        </div>
                                        <% if (canManage) { %>
                                            <div class="dropdown">
                                                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown">
                                                    <i class="bi bi-three-dots-vertical"></i>
                                                </button>
                                                <ul class="dropdown-menu">
                                                    <li>
                                                        <a class="dropdown-item" href="/bestanden/<%= file.id %>/download">
                                                            <i class="bi bi-download me-2"></i>Downloaden
                                                        </a>
                                                    </li>
                                                    <li><hr class="dropdown-divider"></li>
                                                    <li>
                                                        <button class="dropdown-item text-danger" onclick="deleteFile('<%= file.id %>', '<%= file.naam %>')">
                                                            <i class="bi bi-trash me-2"></i>Verwijderen
                                                        </button>
                                                    </li>
                                                </ul>
                                            </div>
                                        <% } else { %>
                                            <a href="/bestanden/<%= file.id %>/download" class="btn btn-sm btn-outline-primary">
                                                <i class="bi bi-download"></i>
                                            </a>
                                        <% } %>
                                    </div>
                                    
                                    <h6 class="card-title text-truncate" title="<%= file.naam %>">
                                        <%= file.naam %>
                                    </h6>
                                    
                                    <div class="file-details">
                                        <small class="text-muted d-block">
                                            <i class="bi bi-calendar me-1"></i>
                                            <%= new Date(file.uploaddatum).toLocaleDateString('nl-NL') %>
                                        </small>
                                        <small class="text-muted d-block">
                                            <i class="bi bi-hdd me-1"></i>
                                            <%= (file.grootte / 1024).toFixed(1) %> KB
                                        </small>
                                        <% if (canManage) { %>
                                            <small class="text-muted d-block">
                                                <i class="bi bi-person me-1"></i>
                                                Eigenaar ID: <%= file.eigenaar %>
                                            </small>
                                        <% } %>
                                    </div>
                                </div>
                            </div>
                        </div>
                    <% }); %>
                </div>
            <% } %>
        </main>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle text-warning me-2"></i>
                    Bestand Verwijderen
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Weet je zeker dat je het bestand <strong id="deleteFileName"></strong> wilt verwijderen?</p>
                <p class="text-danger"><small>Deze actie kan niet ongedaan worden gemaakt.</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuleren</button>
                <form id="deleteForm" method="POST" style="display: inline;">
                    <input type="hidden" name="_method" value="DELETE">
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash me-2"></i>Verwijderen
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Search functionality
document.getElementById('searchFiles').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    filterFiles();
});

// Filter functionality
document.getElementById('filterType').addEventListener('change', filterFiles);
document.getElementById('sortBy').addEventListener('change', sortFiles);

function filterFiles() {
    const searchTerm = document.getElementById('searchFiles').value.toLowerCase();
    const filterType = document.getElementById('filterType').value;
    const fileItems = document.querySelectorAll('.file-item');
    
    fileItems.forEach(item => {
        const name = item.dataset.name;
        const type = item.dataset.type;
        
        const matchesSearch = name.includes(searchTerm);
        const matchesType = !filterType || type.includes(filterType);
        
        if (matchesSearch && matchesType) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
}

function sortFiles() {
    const sortBy = document.getElementById('sortBy').value;
    const container = document.getElementById('filesContainer');
    const items = Array.from(container.children);
    
    items.sort((a, b) => {
        let aValue, bValue;
        
        switch(sortBy) {
            case 'naam':
                aValue = a.dataset.name;
                bValue = b.dataset.name;
                break;
            case 'uploaddatum':
                aValue = new Date(a.dataset.date);
                bValue = new Date(b.dataset.date);
                break;
            case 'grootte':
                aValue = parseInt(a.dataset.size);
                bValue = parseInt(b.dataset.size);
                break;
            case 'type':
                aValue = a.dataset.type;
                bValue = b.dataset.type;
                break;
            default:
                return 0;
        }
        
        if (aValue < bValue) return -1;
        if (aValue > bValue) return 1;
        return 0;
    });
    
    items.forEach(item => container.appendChild(item));
}

// Delete file function
function deleteFile(fileId, fileName) {
    document.getElementById('deleteFileName').textContent = fileName;
    document.getElementById('deleteForm').action = `/bestanden/${fileId}`;
    new bootstrap.Modal(document.getElementById('deleteModal')).show();
}

// File card hover effects
document.querySelectorAll('.file-card').forEach(card => {
    card.addEventListener('mouseenter', function() {
        this.style.transform = 'translateY(-5px)';
        this.style.boxShadow = '0 8px 25px rgba(0,0,0,0.15)';
    });
    
    card.addEventListener('mouseleave', function() {
        this.style.transform = 'translateY(0)';
        this.style.boxShadow = '';
    });
});
</script>

<%- include('../partials/footer') %>